<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>RTI Connext C API: Creating Custom Content Filters</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">RTI Connext C API
   &#160;<span id="projectnumber">Version 5.2.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2-20120808 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__NDDSCustomFilterExampleModule.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Creating Custom Content Filters</div>  </div>
<div class="ingroups"><a class="el" href="group__DDSHowToModule.html">Programming How-To's</a></div></div><!--header-->
<div class="contents">

<p>Working with custom content filters.  
<a href="#details">More...</a></p>
<p>Working with custom content filters. </p>
<h1><a class="anchor" id="NDDSCustomFilterExampleModule_intro"></a>
Introduction</h1>
<p>By default, RTI Connext creates content filters with the DDS_SQL_FILTER, which implements a superset of the DDS-specified SQL WHERE clause. However, in many cases this filter may not be what you want. Some examples are:</p>
<ul>
<li>The default filter can only filter based on the content of a sample, not on a computation on the content of a sample. You can use a custom filter that is customized for a specific type and can filter based on a computation of the type members.</li>
<li>You want to use a different filter language then SQL</li>
</ul>
<p>This HOWTO explains how to write your own custom filter and is divided into the following sections:</p>
<ul>
<li><a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_anatomy">The Custom Content Filter API</a></li>
<li><a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_using_c_format">Example Using C format strings</a></li>
</ul>
<h1><a class="anchor" id="NDDSCustomFilterExampleModule_anatomy"></a>
The Custom Content Filter API</h1>
<p>A custom content filter is created by calling the <a class="el" href="group__DDSDomainParticipantModule.html#gaa4862c16fbd3eae67f66745ae6274e49" title="&lt;&lt;extension&gt;&gt; Register a content filter which can be used to create a DDS_ContentFilteredTopic.">DDS_DomainParticipant_register_contentfilter</a> function with a <a class="el" href="structDDS__ContentFilter.html" title="&lt;&lt;interface&gt;&gt; Interface to be used by a custom filter of a DDS_ContentFilteredTopic">DDS_ContentFilter</a> that contains a <b>compile</b>, an <b>evaluate</b> function and a <b>finalize</b> function. <a class="el" href="group__DDSTopicEntityModule.html#ga84a9ecf9064ecc6b3fb4d8dcc5bda0a6" title="&lt;&lt;interface&gt;&gt; Specialization of DDS_TopicDescription that allows for content-based subscriptions...">DDS_ContentFilteredTopic</a> can be created with <a class="el" href="group__DDSDomainParticipantModule.html#ga2be2a4b5ea1a4eaf338ab7717e102a25" title="&lt;&lt;extension&gt;&gt; Creates a DDS_ContentFilteredTopic using the specified filter to do content-based subsc...">DDS_DomainParticipant_create_contentfilteredtopic_with_filter</a> to use this filter.</p>
<p>A custom content filter is used by RTI Connext at the following times during the life-time of a <a class="el" href="group__DDSTopicEntityModule.html#ga84a9ecf9064ecc6b3fb4d8dcc5bda0a6" title="&lt;&lt;interface&gt;&gt; Specialization of DDS_TopicDescription that allows for content-based subscriptions...">DDS_ContentFilteredTopic</a> (the function called is shown in parenthesis).</p>
<ul>
<li>When a <a class="el" href="group__DDSTopicEntityModule.html#ga84a9ecf9064ecc6b3fb4d8dcc5bda0a6" title="&lt;&lt;interface&gt;&gt; Specialization of DDS_TopicDescription that allows for content-based subscriptions...">DDS_ContentFilteredTopic</a> is created (<a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_compile">compile</a>)</li>
<li>When the filter parameters are changed on the <a class="el" href="group__DDSTopicEntityModule.html#ga84a9ecf9064ecc6b3fb4d8dcc5bda0a6" title="&lt;&lt;interface&gt;&gt; Specialization of DDS_TopicDescription that allows for content-based subscriptions...">DDS_ContentFilteredTopic</a> (<a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_compile">compile</a>) with <a class="el" href="group__DDSTopicEntityModule.html#ga5b784263451a8b22520f7ead80687169" title="Set the expression_parameters.">DDS_ContentFilteredTopic_set_expression_parameters</a></li>
<li>When a sample is filtered (<a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_evaluate">evaluate</a>). This function is called by the RTI Connext core with a de-serialized sample</li>
<li>When a <a class="el" href="group__DDSTopicEntityModule.html#ga84a9ecf9064ecc6b3fb4d8dcc5bda0a6" title="&lt;&lt;interface&gt;&gt; Specialization of DDS_TopicDescription that allows for content-based subscriptions...">DDS_ContentFilteredTopic</a> is deleted (<a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_finalize">finalize</a>)</li>
</ul>
<h2><a class="anchor" id="NDDSCustomFilterExampleModule_compile"></a>
The compile function</h2>
<p>The <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_using_c_format_compile">compile</a> function is used to <b>compile</b> a filter expression and expression parameters. Please note that the term <b>compile</b> is intentionally loosely defined. It is up to the user to decide what this function should do and return.</p>
<p>See <a class="el" href="structDDS__ContentFilter.html#ab60855fd715fa55b62798a423c905a1a" title="Compile an instance of the content filter according to the filter expression and parameters of the gi...">DDS_ContentFilter::compile</a> for details.</p>
<h2><a class="anchor" id="NDDSCustomFilterExampleModule_evaluate"></a>
The evaluate function</h2>
<p>The <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_using_c_format_evaluate">evaluate</a> function is called each time a sample is received to determine if a sample should be filtered out and discarded.</p>
<p>See <a class="el" href="structDDS__ContentFilter.html#a659bd643a4f8e658e445af8b3be54474" title="Evaluate whether the sample is passing the filter or not according to the sample content.">DDS_ContentFilter::evaluate</a> for details.</p>
<h2><a class="anchor" id="NDDSCustomFilterExampleModule_finalize"></a>
The finalize function</h2>
<p>The <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_using_c_format_finalize">finalize</a> function is called when an instance of the custom content filter is no longer needed. When this function is called, it is safe to free all resources used by this particular instance of the custom content filter.</p>
<p>See <a class="el" href="structDDS__ContentFilter.html#ae783dfdfd716d764c991368343ce44bb" title="A previously compiled instance of the content filter is no longer in use and resources can now be cle...">DDS_ContentFilter::finalize</a> for details.</p>
<h1><a class="anchor" id="NDDSCustomFilterExampleModule_using_c_format"></a>
Example Using C format strings</h1>
<p>Assume that you have a type <a class="el" href="structFoo.html" title="A representative user-defined data type.">Foo</a>.</p>
<p>You want to write a custom filter function that will drop all samples where the value of Foo.x &gt; x and x is a value determined by an expression parameter. The filter will <b>only</b> be used to filter samples of type <a class="el" href="structFoo.html" title="A representative user-defined data type.">Foo</a>.</p>
<h2><a class="anchor" id="NDDSCustomFilterExampleModule_using_c_format_compile"></a>
Writing the Compile Function</h2>
<p>The first thing to note is that we can ignore the filter expression, since we already know what the expression is. The second is that x is a parameter that can be changed. By using this information, the compile function is very easy to implement. Simply return the parameter string. This string will then be passed to the evaluate function every time a sample of this type is filtered.</p>
<p>Below is the entire <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_compile">compile</a> function.</p>
<p><div class="fragment"><div class="line"></div>
<div class="line"><a class="code" href="group__DDSReturnTypesModule.html#ga73f148aaf96b5f6f9fc630b7cfeb0c91" title="Type for return codes.">DDS_ReturnCode_t</a></div>
<div class="line">howto_write_simple_compile_function(<span class="keywordtype">void</span> *handle,</div>
<div class="line">                                    <span class="keywordtype">void</span> **new_compile_data,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *expression,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structDDS__StringSeq.html" title="Instantiates FooSeq &lt; ::char* &gt; with value type semantics.">DDS_StringSeq</a> *parameters,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structDDS__TypeCode.html" title="The definition of a particular data type, which you can use to inspect the name, members, and other properties of types generated with rtiddsgen or to modify types you define yourself at runtime.">DDS_TypeCode</a> *type_code,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *type_class_name,</div>
<div class="line">                                    <span class="keywordtype">void</span> *old_compile_data)</div>
<div class="line">{</div>
<div class="line">    *new_compile_data = (<span class="keywordtype">void</span>*)<a class="code" href="group__DDSStringClass.html#gaaadc788c3850b5625c6d78794943db7d" title="Clone a string. Creates a new string that duplicates the value of string.">DDS_String_dup</a>(*DDS_StringSeq_get_reference(parameters,0));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__DDSReturnTypesModule.html#gga73f148aaf96b5f6f9fc630b7cfeb0c91a4f3bc70d86031a38bba356c4b534979f" title="Successful return.">DDS_RETCODE_OK</a>;</div>
<div class="line">}</div>
</div><!-- fragment --></p>
<h2><a class="anchor" id="NDDSCustomFilterExampleModule_using_c_format_evaluate"></a>
Writing the Evaluate Function</h2>
<p>The next step is to implement the <b>evaluate</b> function. The evaluate function receives the parameter string with the actual value to test against. Thus the evaluate function must read the actual value from the parameter string before evaluating the expression. Below is the entire <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_evaluate">evaluate</a> function.</p>
<p><div class="fragment"><div class="line"></div>
<div class="line"><a class="code" href="group__DDSCdrTypesModule.html#ga19b2e2f603cfff0021ec54dc57ceae7d" title="Defines a Boolean data type, equivalent to IDL/CDR boolean.">DDS_Boolean</a></div>
<div class="line">howto_write_simple_evaluate_function(<span class="keywordtype">void</span> *filter_data,</div>
<div class="line">                                     <span class="keywordtype">void</span> *compile_data,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">void</span> *sample,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structDDS__FilterSampleInfo.html" title="Provides meta information associated with the sample.">DDS_FilterSampleInfo</a> * meta_data)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *parameter = (<span class="keywordtype">char</span>*)compile_data;</div>
<div class="line">    <a class="code" href="group__DDSCdrTypesModule.html#gadf1aad514e46148e661fc43b61845ed6" title="Defines a long integer data type, equivalent to IDL/CDR long.">DDS_Long</a> x;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structFoo.html" title="A representative user-defined data type.">Foo</a> *foo_sample = (<a class="code" href="structFoo.html" title="A representative user-defined data type.">Foo</a>*)sample;</div>
<div class="line"></div>
<div class="line">    sscanf(parameter,<span class="stringliteral">&quot;%d&quot;</span>,&amp;x);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> (foo_sample-&gt;x &gt; x ? <a class="code" href="group__DDSCdrTypesModule.html#ga727fba6a96485884ccd9438b560689f7" title="Defines &quot;false&quot; value of DDS_Boolean data type.">DDS_BOOLEAN_FALSE</a> : <a class="code" href="group__DDSCdrTypesModule.html#ga02f257a405ea7ff6774cdf4330a7eeb7" title="Defines &quot;true&quot; value of DDS_Boolean data type.">DDS_BOOLEAN_TRUE</a>);</div>
<div class="line">}</div>
</div><!-- fragment --></p>
<h2><a class="anchor" id="NDDSCustomFilterExampleModule_using_c_format_finalize"></a>
Writing the Finalize Function</h2>
<p>The last function to write is the finalize function. It is safe to free all resources used by this particular instance of the custom content filter that is allocated in <b>compile</b>. Below is the entire <a class="el" href="group__NDDSCustomFilterExampleModule.html#NDDSCustomFilterExampleModule_finalize">finalize</a> function.</p>
<p><div class="fragment"><div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">howto_write_simple_finalize_function(<span class="keywordtype">void</span> *filter_data,</div>
<div class="line">                                     <span class="keywordtype">void</span> *compile_data)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* free parameter string from compile function */</span></div>
<div class="line">    <a class="code" href="group__DDSStringClass.html#ga13074f0132f743923a4a36ee533997fe" title="Delete a string.">DDS_String_free</a>((<span class="keywordtype">char</span> *)compile_data);</div>
<div class="line">}</div>
</div><!-- fragment --></p>
<h2><a class="anchor" id="NDDSCustomFilterExampleModule_using_c_format_register"></a>
Registering the Filter</h2>
<p>Before the custom filter can be used, it must be registered with RTI Connext:</p>
<p><div class="fragment"><div class="line"></div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structDDS__ContentFilter.html" title="&lt;&lt;interface&gt;&gt; Interface to be used by a custom filter of a DDS_ContentFilteredTopic">DDS_ContentFilter</a> filter = <a class="code" href="group__DDSTopicEntityModule.html#ga5284f3a21ed7851e620d236c914e3f82" title="Initializer for new DDS_ContentFilter.">DDS_ContentFilter_INITIALIZER</a>;</div>
<div class="line">    filter.<a class="code" href="structDDS__ContentFilter.html#ab60855fd715fa55b62798a423c905a1a" title="Compile an instance of the content filter according to the filter expression and parameters of the gi...">compile</a> = howto_write_simple_compile_function;</div>
<div class="line">    filter.<a class="code" href="structDDS__ContentFilter.html#a659bd643a4f8e658e445af8b3be54474" title="Evaluate whether the sample is passing the filter or not according to the sample content.">evaluate</a> = howto_write_simple_evaluate_function;</div>
<div class="line">    filter.<a class="code" href="structDDS__ContentFilter.html#ae783dfdfd716d764c991368343ce44bb" title="A previously compiled instance of the content filter is no longer in use and resources can now be cle...">finalize</a> = howto_write_simple_finalize_function;</div>
<div class="line">    filter.<a class="code" href="structDDS__ContentFilter.html#af730c559f5d00dc32dce79111bed8c70" title="A place for filter implementors to keep a pointer to data that may be needed by their filter...">filter_data</a> = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__DDSDomainParticipantModule.html#gaa4862c16fbd3eae67f66745ae6274e49" title="&lt;&lt;extension&gt;&gt; Register a content filter which can be used to create a DDS_ContentFilteredTopic.">DDS_DomainParticipant_register_contentfilter</a>(</div>
<div class="line">        participant, <span class="stringliteral">&quot;MyCustomFilter&quot;</span>, &amp;filter) != <a class="code" href="group__DDSReturnTypesModule.html#gga73f148aaf96b5f6f9fc630b7cfeb0c91a4f3bc70d86031a38bba356c4b534979f" title="Successful return.">DDS_RETCODE_OK</a>) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Failed to register custom filter\n&quot;</span>);</div>
<div class="line">    }</div>
</div><!-- fragment --></p>
<h2><a class="anchor" id="NDDSCustomFilterExampleModule_using_c_format_unregister"></a>
Unregistering the Filter</h2>
<p>When the filter is no longer needed, it can be unregistered from RTI Connext:</p>
<p><div class="fragment"><div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__DDSDomainParticipantModule.html#ga62c4192bb94aa896dc46cad342fe7ee9" title="&lt;&lt;extension&gt;&gt; Unregister a content filter previously registered with DDS_DomainParticipant_register_c...">DDS_DomainParticipant_unregister_contentfilter</a>(</div>
<div class="line">        participant, <span class="stringliteral">&quot;MyCustomFilter&quot;</span> ) != <a class="code" href="group__DDSReturnTypesModule.html#gga73f148aaf96b5f6f9fc630b7cfeb0c91a4f3bc70d86031a38bba356c4b534979f" title="Successful return.">DDS_RETCODE_OK</a>) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Failed to unregister custom filter\n&quot;</span>);</div>
<div class="line">    }</div>
</div><!-- fragment --> </p>
</div><!-- contents -->
</div><!-- doc-content -->
<HR>
<IMG SRC="rti_logo.gif" height="16">
<A HREF="main.html">RTI Connext C API Version 5.2.3</A>
Copyright &copy; Wed Apr 27 2016 
<A HREF="http://www.rti.com">Real-Time Innovations, Inc</A>
</BODY>
</HTML>
